name: Auto Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:  # Возможность запустить вручную
  workflow_run:
    workflows: ["Sync Fork"]  # Ждём завершения sync-fork.yml
    types:
      - completed

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # Используем PAT для пуша

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Fix duplicate refspec error
        run: |
          git remote prune origin
          git branch -r
          git fetch --all
          git checkout main
          git reset --hard origin/main

      - name: Pull latest changes from origin
        run: |
          git fetch origin main
          git checkout main
          git pull origin main --rebase

      - name: Merge PR branch
        env:
          PR_BRANCH: ${{ github.head_ref }}
        run: |
          git merge --no-ff origin/$PR_BRANCH || true  # Если конфликты, решаем вручную
          
      - name: Debug PAT_TOKEN
        run: |
          if [[ -z "${{ secrets.PAT_TOKEN }}" ]]; then
            echo "PAT_TOKEN is missing!"
            exit 1
          else
            echo "PAT_TOKEN is set!"
          fi
      - name: Debug Git State
        run: |
          git remote -v
          git branch -a
          git show-ref | grep main || echo "No main ref found"
      - name: Push merged changes
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:$PAT_TOKEN@github.com/${{ github.repository }}.git
          git push origin HEAD:main --force
